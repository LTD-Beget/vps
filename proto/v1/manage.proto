syntax = "proto3";

package beget.vps.v1.manage;

import "google/api/annotations.proto";
import "vps/proto/v1/structures.proto";

service ManageService {
    // Создать VPS
    rpc createVps (CreateVpsRequest) returns (CreateVpsResponse) {
        option (google.api.http) = {
            post: "/v1/vps/server"
            body: "*"
        };
    }

    // Получить доступные варианты конфигурации VPS
    rpc getAvailableConfiguration (GetAvailableConfigurationRequest) returns (GetAvailableConfigurationResponse) {
        option (google.api.http) = {
            get: "/v1/vps/configuration"
        };
    }

    // Получить список VPS
    rpc getList (GetListRequest) returns (GetListResponse) {
        option (google.api.http) = {
            get: "/v1/vps/server/list"
        };
    }

    // Получить статусы всех VPS
    rpc getStatuses (GetStatusesRequest) returns (GetStatusesResponse) {
        option (google.api.http) = {
            get: "/v1/vps/server/statuses"
        };
    }

    // Получить информацию по VPS
    rpc getInfo (GetInfoRequest) returns (GetInfoResponse) {
        option (google.api.http) = {
            get: "/v1/vps/server/{id}"
        };
    }

    // Запустить VPS
    rpc startVps (StartVpsRequest) returns (StartVpsResponse) {
        option (google.api.http) = {
            post: "/v1/vps/server/{id}/start"
        };
    }

    // Остановить VPS
    rpc stopVps (StopVpsRequest) returns (StopVpsResponse) {
        option (google.api.http) = {
            post: "/v1/vps/server/{id}/stop"
        };
    }

    // Перезагрузить(reboot) VPS
    rpc rebootVps (RebootVpsRequest) returns (RebootVpsResponse) {
        option (google.api.http) = {
            post: "/v1/vps/server/{id}/reboot"
        };
    }

    // Перезагрузить(reset) VPS
    rpc resetVps (ResetVpsRequest) returns (ResetVpsResponse) {
        option (google.api.http) = {
            post: "/v1/vps/server/{id}/reset"
        };
    }

    // Удалить VPS
    rpc removeVps (RemoveVpsRequest) returns (RemoveVpsResponse) {
        option (google.api.http) = {
            post: "/v1/vps/server/{id}/remove"
        };
    }

    // Включить rescue-режим для VPS
    rpc startRescue (StartRescueRequest) returns (StartRescueResponse) {
        option (google.api.http) = {
            post: "/v1/vps/server/{id}/rescue"
        };
    }

    // Выключить rescue-режим для VPS
    rpc stopRescue (StopRescueRequest) returns (StopRescueResponse) {
        option (google.api.http) = {
            delete: "/v1/vps/server/{id}/rescue"
        };
    }

    // Сменить тариф VPS
    rpc changeConfiguration (ChangeConfigurationRequest) returns (ChangeConfigurationResponse) {
        option (google.api.http) = {
            put: "/v1/vps/server/{id}/configuration"
            body: "*"
        };
    }

    // Пересоздать VPS
    rpc reinstall (ReinstallRequest) returns (ReinstallResponse) {
        option (google.api.http) = {
            post: "/v1/vps/server/{id}/reinstall"
            body: "*"
        };
    }

    // Обновить информацию о VPS
    rpc updateInfo (UpdateInfoRequest) returns (UpdateInfoResponse) {
        option (google.api.http) = {
            put: "/v1/vps/server/{id}/info"
            body: "*"
        };
    }

    // Получить историю действий с VPS
    rpc getHistory (GetHistoryRequest) returns (GetHistoryResponse) {
        option (google.api.http) = {
            get: "/v1/vps/{id}/history"
        };
    }

    // Добавить публичный ssh-ключ в хранилище
    rpc attachSshKey (AttachSshKeyRequest) returns (AttachSshKeyResponse) {
        option (google.api.http) = {
            post: "/v1/vps/{id}/sshKey/{ssh_key_id}"
        };
    }

    // Удалить публичный ssh-ключ из хранилища
    rpc detachSshKey (DetachSshKeyRequest) returns (DetachSshKeyResponse) {
        option (google.api.http) = {
            delete: "/v1/vps/{id}/sshKey/{ssh_key_id}"
        };
    }

    // Сбросить пароль VPS
    rpc resetPassword (ResetPasswordRequest) returns (ResetPasswordResponse) {
        option (google.api.http) = {
            put: "/v1/vps/{id}/password"
        };
    }

    // Прикрепить дополнительный IP адрес к VPS
    rpc attachIpAddress (AttachIpAddressRequest) returns (AttachIpAddressResponse) {
        option (google.api.http) = {
            post: "/v1/vps/{id}/network/{ip_address}"
            body: "*"
        };
    }

    // Открепить дополнительный IP адрес от VPS
    rpc detachIpAddress (DetachIpAddressRequest) returns (DetachIpAddressResponse) {
        option (google.api.http) = {
            delete: "/v1/vps/network/detach/{ip_address}"
        };
    }

    // Добавить VPS к приватной сети
    rpc attachToPrivateNetwork (AttachToPrivateNetworkRequest) returns (AttachToPrivateNetworkResponse) {
        option (google.api.http) = {
            post: "/v1/vps/{id}/private-network/{network_id}"
            body: "*"
        };
    }

    // Удалить VPS из приватной сети
    rpc detachFromPrivateNetwork (DetachFromPrivateNetworkRequest) returns (DetachFromPrivateNetworkResponse) {
        option (google.api.http) = {
            delete: "/v1/vps/{id}/private-network/{network_id}"
        };
    }

    // Открыть/закрыть доступ к VPS файловому менеджеру
    rpc changeSshAccess (ChangeSshAccessRequest) returns (ChangeSshAccessResponse) {
        option (google.api.http) = {
            put: "/v1/vps/{id}/ssh/access"
            body: "*"
        };
    }

    // Возвращает необходимые параметры сессии для перехода в файловый менеджер
    rpc getFileManagerSettings (GetFileManagerSettingsRequest) returns (GetFileManagerSettingsResponse) {
        option (google.api.http) = {
            post: "/v1/vps/{id}/fm"
        };
    }

    // Получить список установленного ПО на VPS
    rpc getInstalledSoftware (GetInstalledSoftwareRequest) returns (GetInstalledSoftwareResponse) {
        option (google.api.http) = {
            get: "/v1/vps/{id}/software"
        };
    }

    // Получить список доступного для установки ПО
    rpc getAvailableSoftware (GetAvailableSoftwareRequest) returns (GetAvailableSoftwareResponse) {
        option (google.api.http) = {
            get: "/v1/vps/software"
        };
    }

    // Проверить возможность установки ПО
    rpc checkSoftwareRequirements (CheckSoftwareRequirementsRequest) returns (CheckSoftwareRequirementsResponse) {
        option (google.api.http) = {
            post: "/v1/vps/software/requirements"
            body: "*"
        };
    }

    // Разархивировать VPS
    rpc unarchive (UnarchiveRequest) returns (UnarchiveResponse) {
        option (google.api.http) = {
            delete: "/v1/vps/archive/{id}"
        };
    }

    // Зарезервировать поддомен для VPS
    rpc reserveVpsSubdomain(ReserveVpsSubdomainRequest) returns (ReserveVpsSubdomainResponse) {
        option (google.api.http) = {
            get: "/v1/vps/subdomain/reserve"
        };
    }
}

message CheckSoftwareRequirementsRequest {
    // Идентификатор ОС
    uint32 operating_system_id = 1;

    // Выбранное ПО для установки
    SoftwareInstallInfo info = 2;
}

message CheckSoftwareRequirementsResponse {
    // Ошибка при проверке возможности установки ПО
    Error error = 2;

    message Error {
        // Ошибка связанная с доменом
        DomainError wordpress_error = 1 [deprecated=true];

        oneof type {
            // Ошибка связанная с доменом
            DomainError domain_error = 2;
        }

        // Ошибки связанные с доменом
        enum DomainError {
            // Зарезервированный код ошибки
            _ = 0;

            // Домен не зарегистрирован
            DOMAIN_NOT_REGISTERED = 1;
           
            // Домен зарегистрирован через Beget и у него сторонние NS-записи(не ns1.beget.com/etc)
            WRONG_NS_RECORD = 2;

            // Домен зарегистрирован у стороннего регистратора и не делегирован Beget
            DOMAIN_NOT_DELEGATED = 3;

            // Некорректное имя домена
            INVALID_DOMAIN = 4;

            // Домен зарегистрирован меньше 12 часов назад
            DOMAIN_IS_NEW = 5;
        }
    }
}

message GetAvailableSoftwareRequest {

}

message GetAvailableSoftwareResponse {
    // Список с описанием установленного ПО
    repeated SoftwareInfo software = 1;

    message SoftwareInfo {
        // Идентификатор ПО
        uint32 id = 1;

        // Назнание ПО
        string name = 2;

        // Отображаемое название ПО
        string display_name = 3;

        // Версия
        string version = 4;

        // Тип ПО
        Type type = 5;

        // Описание ПО
        string description = 6;

        // Дополнительное описание для конкретной версии ПО
        string description_version = 7;

        // Список ID образов, для которых возможна установка этого ПО
        repeated uint32 image_id = 8;

        // Список дополнительных полей, которые необходимо передать для установки ПО
        repeated string variable = 9;

        // Минимальные требования к конфигурации для установки
        Requirements requirements = 10;

        message Requirements {
            // Количество ядер процессора
            uint32 cpu_count = 1;

            // Размер диска, указывается в Mb
            uint32 disk_size = 2;

            // Объем оперативной памяти, указывается в Mb
            uint32 memory = 3;
        }

        enum Type {
            // Панель управления
            PANEL = 0;

            // Остальное ПО
            SOFTWARE = 1;
        }
    }
}

message GetInstalledSoftwareRequest {
    // Идентификатор VPS в формате uuid v4
    string id = 1;
}

message GetInstalledSoftwareResponse {
    // Список установленного ПО на VPS
    repeated structures.InstalledSoftwareInfo software = 1;
}

message CreateVpsRequest {
    // Отображаемое имя VPS
    string display_name = 1;

    // Имя хоста в операционной системе
    string hostname = 2;

    // Дополнительное описание VPS
    string description = 3;

    // Необходима конфигурация(тариф)
    string configuration_id = 4;

    oneof source {
        // Идентификатор ОС
        uint32 operating_system_id = 5;

        // Идентификатор снапшота, который восстановится в новую VPS
        uint64 snapshot_id = 11;
    }

    // ID публичных ssh-ключей, которые будут добавлены в VPS
    repeated uint32 ssh_keys = 6;

    // Пароль (должен включать минимум 1 upper, 1 lower, 1 digit, 1 special char. Мин длина - 8 символов)
    string password = 7;

    // Открыть доступ к VPS файловому менеджеру
    bool beget_ssh_access_allowed = 8;

    // Информация о ПО, которое необходимо установить
    repeated SoftwareInstallInfo software = 10;

    // Приватные сети, к которым необходимо подключить VPS
    repeated PrivateNetworkInfo private_networks = 12;
}


message CreateVpsResponse {
    oneof result {
        // Информация о VPS
        VpsInfo vps = 1;

        // Ошибка при создании VPS
        Error error = 2;
    }

    message Error {
        // Код ошибки
        Code code = 1;

        // Описание ошибки
        string message = 2;

        oneof extra {
            // Расширенное описание ошибки
            SoftwareVariableError variable_error = 3;
        }

        enum Code {
            // Внутренняя ошибка
            INTERNAL_ERROR = 0;

            // Некорректное поле display_name
            INVALID_DISPLAY_NAME = 1;

            // Некорректное поле hostnames
            INVALID_HOSTNAME = 2;

            // Некорректные остальные параметры конфигурации (public_key, operating_system_id, configuration_name)
            INVALID_PARAMS = 3;

            // Недостаточно средств на счету
            INSUFFICIENT_FUNDS = 4;

            // Доступ к VPS заблокирован
            SERVICE_DISABLED = 5;

            // Неправильная конфигурация параметров доступа к VPS (не выбран ни логин, ни доступ по ключу)
            INVALID_SECURITY_CONFIGURATION = 6;

            // Некорректное поле password
            INVALID_PASSWORD = 7;

            // Действие в данный момент недоступно
            TEMPORARILY_UNAVAILABLE = 8;

            // Некорректная комбинация типов ПО
            SOFTWARE_INVALID_TYPE = 9;

            // Недостаточно ресурсов для устанавливаемого ПО на выбранном тарифе
            SOFTWARE_NOT_ENOUGH_RESOURCES = 10;

            // Пропущены обязательные переменные для устанавливаемого ПО
            SOFTWARE_VARIABLE_REQUIRED = 11;

            // Некорректная переменная для устанавливаемого ПО, подробности в `variable_error`
            SOFTWARE_VARIABLE_INVALID = 12;

            // Невозможно создать из снапшота(снапшот в процессе создания)
            SNAPSHOT_NOT_DONE = 13;

            // Конфигурация снапшота не подходит для выбранного тарифа
            SNAPSHOT_NOT_ENOUGH_CONFIGURATION = 14;

            // Некорректная конфигурация приватной сети
            INVALID_PRIVATE_NETWORK_CONFIGURATION = 15;

            // Передан некорректный адрес
            INVALID_ADDRESS = 16;

            // Переданный адрес не соответствует подсети
            ADDRESS_SUBNET_MISMATCH = 17;

            // Переданный адрес уже выделен
            ADDRESS_ALREADY_RESERVED = 18;

            // Переданный адрес недоступен
            ADDRESS_UNAVAILABLE = 19;

            // Пароль содержится в чёрном списке
            BLACKLISTED_PASSWORD = 20;
        }

        message SoftwareVariableError {
            // Идентификатор устанавливаемого ПО
            uint32 id = 1;

            // Список ошибок
            repeated ValueError error = 2;

            message ValueError {
                // Название поля содержащее ошибку
                string variable = 1;

                // Описание ошибки на русском
                string error_text_ru = 2;

                // описание ошибки на английском
                string error_text_en = 3;
            }
        }
    }
}

message GetListRequest {
}

message GetListResponse {
    // Информация о всех VPS
    repeated VpsInfo vps = 1;
}


message GetInfoRequest {
    // Идентификатор VPS, в формате uuid v4
    string id = 1;
}

message GetInfoResponse {
    // Информация о VPS
    VpsInfo vps = 1;
}


message GetStatusesRequest {
}

message GetStatusesResponse {
    // Список VPS с описанием их статусов
    repeated StatusInfo statuses = 1;

    message StatusInfo {
        // Идентификатор VPS, в формате uuid v4
        string id = 1;

        // Статус VPS
        VpsStatus status = 2;

        // Включен rescue-режим
        bool rescue_mode = 3;

        // VPS находится в состоянии миграции на другой хост
        bool migrating = 4;

        // Доступно ли управление VPS
        bool manage_enabled = 5;

        // VPS находится в состоянии восстановления из резервной копии
        bool restoring = 6;

        // VPS заархивирована, управление невозможно
        bool archived = 7;

        // VPS в процессе разблокировки
        bool unblocking = 8;

        // VPS в процессе разархивации
        bool unarchiving = 9;
    }
}

message StartVpsRequest {
    // Идентификатор VPS, в формате uuid v4
    string id = 1;
}

message StartVpsResponse {
    oneof result {
        // Информация о VPS
        VpsInfo vps = 1;

        // Ошибка при включении VPS
        Error error = 2;
    }

    message Error {
        // Код ошибки
        Code code = 1;

        // Описание ошибки
        string message = 2;

        enum Code {
            // Внутренняя ошибка
            INTERNAL_ERROR = 0;

            // Операция не может быть выполнена, т.к. VPS находится в невалидном состоянии (например, сейчас перезапускается)
            INVALID_STATE = 1;

            // Доступ к VPS заблокирован
            SERVICE_DISABLED = 2;
        }
    }
}

message StopVpsRequest {
    // Идентификатор VPS, в формате uuid v4
    string id = 1;
}

message StopVpsResponse {
    oneof result {
        // Информация о VPS
        VpsInfo vps = 1;

        // Ошибка при выключении VPS
        Error error = 2;
    }

    message Error {
        // Код ошибки
        Code code = 1;

        // Описание ошибки
        string message = 2;

        enum Code {
            // Внутренняя ошибка
            INTERNAL_ERROR = 0;

            // Операция не может быть выполнена, т.к. VPS находится в невалидном состоянии (например, сейчас перезапускается)
            INVALID_STATE = 1;

            // Доступ к VPS заблокирован
            SERVICE_DISABLED = 2;
        }
    }
}

message RebootVpsRequest {
    // Идентификатор VPS, в формате uuid v4
    string id = 1;
}

message RebootVpsResponse {
    oneof result {
        // Информация о VPS
        VpsInfo vps = 1;

        // Ошибка при перезагрузке VPS
        Error error = 2;
    }

    message Error {
        // Код ошибки
        Code code = 1;

        // Описание ошибки
        string message = 2;

        enum Code {
            // Внутренняя ошибка
            INTERNAL_ERROR = 0;

            // Операция не может быть выполнена, т.к. Vps находится в невалидном состоянии (например, сейчас перезапускается)
            INVALID_STATE = 1;

            // Доступ к VPS заблокирован
            SERVICE_DISABLED = 2;
        }
    }
}

message ResetVpsRequest {
    // Идентификатор VPS, в формате uuid v4
    string id = 1;
}

message ResetVpsResponse {
    oneof result {
        // Информация о VPS
        VpsInfo vps = 1;

        // Ошибка при перезагрузке VPS
        Error error = 2;
    }

    message Error {
        // Код ошибки
        Code code = 1;

        // Описание ошибки
        string message = 2;

        enum Code {
            // Внутренняя ошибка
            INTERNAL_ERROR = 0;

            // Операция не может быть выполнена, т.к. VPS находится в невалидном состоянии (например, сейчас перезапускается)
            INVALID_STATE = 1;

            // Доступ к VPS заблокирован
            SERVICE_DISABLED = 2;
        }
    }
}

message RemoveVpsRequest {
    // Идентификатор VPS, в формате uuid v4
    string id = 1;
}

message RemoveVpsResponse {
    oneof result {
        // Информация о VPS
        VpsInfo vps = 1;

        // Ошибка при удалении VPS
        Error error = 2;
    }

    message Error {
        // Код ошибки
        Code code = 1;

        // Описание ошибки
        string message = 2;

        enum Code {
            // Внутренняя ошибка
            INTERNAL_ERROR = 0;

            // Операция не может быть выполнена, т.к. VPS находится в невалидном состоянии (например, сейчас перезапускается)
            INVALID_STATE = 1;

            // Доступ к VPS заблокирован
            SERVICE_DISABLED = 2;
        }
    }
}

message StartRescueRequest {
    // Идентификатор VPS, в формате uuid v4
    string id = 1;
}

message StartRescueResponse {
    oneof result {
        // Информация о VPS
        VpsInfo vps = 1;

        // Ошибка при включении rescue режима
        Error error = 2;
    }

    message Error {
        // Код ошибки
        Code code = 1;

        // Описание ошибки
        string message = 2;

        enum Code {
            // Внутренняя ошибка
            INTERNAL_ERROR = 0;

            // Операция не может быть выполнена, т.к. VPS находится в невалидном состоянии (например, сейчас перезапускается)
            INVALID_STATE = 1;

            // Доступ к VPS заблокирован
            SERVICE_DISABLED = 2;
        }
    }
}

message StopRescueRequest {
    // Идентификатор VPS, в формате uuid v4
    string id = 1;
}

message StopRescueResponse {
    oneof result {
        // Информация о VPS
        VpsInfo vps = 1;

        // Ошибка при отключении rescue режима
        Error error = 2;
    }

    message Error {
        // Код ошибки
        Code code = 1;

        // Описание ошибки
        string message = 2;

        enum Code {
            // Внутренняя ошибка
            INTERNAL_ERROR = 0;

            // Операция не может быть выполнена, т.к. VPS находится в невалидном состоянии (например, сейчас перезапускается)
            INVALID_STATE = 1;

            // Доступ к VPS заблокирован
            SERVICE_DISABLED = 2;
        }
    }
}

message ChangeConfigurationRequest {
    // Идентификатор VPS, в формате uuid v4
    string id = 1;

    // Название конфигурации(тарифа)
    string configuration_id = 2;
}

message ChangeConfigurationResponse {
    oneof result {
        // Информация о VPS
        VpsInfo vps = 1;

        // Ошибка при смене конфигурации VPS
        Error error = 2;
    }

    message Error {
        // Код ошибки
        Code code = 1;

        // Описание ошибки
        string message = 2;

        enum Code {
            // Внутренняя ошибка
            INTERNAL_ERROR = 0;

            // Операция не может быть выполнена, т.к. VPS находится в невалидном состоянии (например, сейчас перезапускается)
            INVALID_STATE = 1;

            // Доступ к VPS заблокирован
            SERVICE_DISABLED = 2;

            // Недостаточно средств на счету
            INSUFFICIENT_FUNDS = 3;

            // Переданная конфигурация не может быть применена из-за ограничений (например, в ней меньше ресурсов, чем в текущей)
            INVALID_CONFIGURATION = 4;

            // Действие в данный момент недоступно
            TEMPORARILY_UNAVAILABLE = 5;
        }
    }
}

message ReinstallRequest {
    // Идентификатор VPS, в формате uuid v4
    string id = 1;

    // Идентификатор ОС
    uint32 operating_system_id = 2;

    // ID публичных ssh-ключей
    repeated uint32 ssh_keys = 3;

    // Пароль (должен включать минимум 1 upper, 1 lower, 1 digit, 1 special char. Мин длина - 8 символов)
    string password = 4;

    // Информация о ПО, которое необходимо установить
    repeated SoftwareInstallInfo software = 6;
}

message ReinstallResponse {
    oneof result {
        // Информация о VPS
        VpsInfo vps = 1;

        // Ошибка при переустановке VPS
        Error error = 2;
    }

    message Error {
        // Код ошибки
        Code code = 1;

        // Описание ошибки
        string message = 2;

        oneof extra {
            // Расширенное описание ошибки
            SoftwareVariableError variable_error = 3;
        }

        enum Code {
            // Внутренняя ошибка
            INTERNAL_ERROR = 0;

            // Операция не может быть выполнена, т.к. VPS находится в невалидном состоянии (например, сейчас перезапускается)
            INVALID_STATE = 1;

            // Пользователю заблокирован доступ к управлению VPS
            SERVICE_DISABLED = 2;

            // Переданная конфигурация не может быть применена из-за ограничений
            INVALID_CONFIGURATION = 3;

            // Неправильная конфигурация параметров доступа к VPS (не выбран ни логин, ни доступ по ключу)
            INVALID_SECURITY_CONFIGURATION = 4;

            // Некорректное поле password
            INVALID_PASSWORD = 5;

            // Некорректная комбинация типов ПО
            SOFTWARE_INVALID_TYPE = 6;

            // Недостаточно ресурсов для устанавливаемого ПО на выбранном тарифном плане
            SOFTWARE_NOT_ENOUGH_RESOURCES = 7;

            // Некорректные остальные параметры конфигурации (public_key, operating_system_id, configuration_name)
            INVALID_PARAMS = 8;

            // Пропущены обязательные переменные для устанавливаемого ПО
            SOFTWARE_VARIABLE_REQUIRED = 9;

            // Некоррктная переменная для устанавливаемого ПО, подробности содержатся в `variable_error`
            SOFTWARE_VARIABLE_INVALID = 10;

            // Пароль содержится в чёрном списке
            BLACKLISTED_PASSWORD = 11;
        }

        message SoftwareVariableError {
            // Идентификатор устанавливаемого ПО
            uint32 id = 1;

            // Список ошибок
            repeated ValueError error = 2;

            message ValueError {
                // Параметр в котором возникла ошибка
                string variable = 1;

                // Описание ошибки на русском
                string error_text_ru = 2;

                // Описание ошибки на английском
                string error_text_en = 3;
            }
        }
    }
}

message GetAvailableConfigurationRequest {
}

message GetAvailableConfigurationResponse {
    // Список доступных конфигураций VPS
    repeated VpsConfiguration configurations = 1;

    // Список ОС
    repeated structures.OperatingSystem operating_systems = 2;
}


message UpdateInfoRequest {
    // Идентификатор VPS, в формате uuid v4
    string id = 1;

    // Отображаемое имя VPS
    string display_name = 2;

    // Имя хоста в ОС
    string hostname = 3;

    // Описание VPS
    string description = 4;
}

message UpdateInfoResponse {
    oneof result {
        // Информация о VPS
        VpsInfo vps = 1;

        // Ошибка при обновлении информации о VPS
        Error error = 2;
    }

    message Error {
        // Код ошибки
        Code code = 1;

        // Описание ошибки
        string message = 2;

        enum Code {
            // Внутренняя ошибка
            INTERNAL_ERROR = 0;

            // Некорректное поле display_name
            INVALID_DISPLAY_NAME = 1;

            // Некорректное поле hostnames
            INVALID_HOSTNAME = 2;

            // Пользователю заблокирован доступ к управлению VPS
            SERVICE_DISABLED = 3;
        }
    }
}

message GetHistoryRequest {
    // Идентификатор VPS в формате uuid v4
    string id = 1;
}

message GetHistoryResponse {
    // История действий с VPS
    repeated HistoryItem history = 1;
}

message AttachSshKeyRequest {
    // Идентификатор VPS в формате uuid v4
    string id = 1;

    // ID публичного ключа
    uint32 ssh_key_id = 2;
}

message AttachSshKeyResponse {
    oneof result {
        // Информация о VPS
        VpsInfo vps = 1;

        // Ошибка при добавлении публичного SSH ключа в хранилище
        Error error = 2;
    }

    message Error {
        Code code = 1;
        string message = 2;

        enum Code {
            // Внутренняя ошибка
            INTERNAL_ERROR = 0;

            // Пользователю заблокирован доступ к управлению VPS
            SERVICE_DISABLED = 1;
        }
    }
}

message DetachSshKeyRequest {
    // Идентификатор VPS в формате uuid v4
    string id = 1;

    // ID публичного ключа
    uint32 ssh_key_id = 2;
}

message DetachSshKeyResponse {
    oneof result {
        // Информация о VPS
        VpsInfo vps = 1;

        // Ошибка при удалении публичного SSH ключа из хранилища
        Error error = 2;
    }

    message Error {
        // Код ошибки
        Code code = 1;

        // Описание ошибки
        string message = 2;

        enum Code {
            // Внутренняя ошибка
            INTERNAL_ERROR = 0;

            // Пользователю заблокирован доступ к управлению VPS
            SERVICE_DISABLED = 1;
        }
    }
}

message ResetPasswordRequest {
    // Идентификатор VPS в формате uuid v4
    string id = 1;
}

message ResetPasswordResponse {
    oneof result {
        // Информация о VPS
        VpsInfo vps = 1;

        // Ошибка при сбросе пароля
        Error error = 2;
    }

    message Error {
        // Код ошибка
        Code code = 1;

        // Описание ошибки
        string message = 2;

        enum Code {
            // Внутренняя ошибка
            INTERNAL_ERROR = 0;

            // Пользователю заблокирован доступ к управлению VPS
            SERVICE_DISABLED = 1;
        }
    }
}


message HistoryItem {
    // Дата
    string date = 1;

    // Событие
    HistoryItemType type = 2;

    // Было ли завершено ошибкой
    bool has_error = 3;

    // Варианты событий
    enum HistoryItemType {
        // Неизвестно
        UNKNOWN = 0;

        // Создание VPS
        CREATE = 1;

        // Запуск VPS
        START = 2;

        // Остановка VPS
        STOP = 3;

        // Перезагрузка VPS
        RESTART = 4;

        // Переустановка VPS
        REINSTALL = 5;

        // Переконфигурация VPS
        RECONFIGURE = 6;

        // Удаление VPS
        REMOVE = 7;
    }
}

message VpsInfo {
    // Идентификатор VPS в формате uuid v4
    string id = 1;

    // ЧПУ-френдли имя VPS (может быть пустой строкой)
    string slug = 2;

    // Отображаемое имя VPS
    string display_name = 3;

    // Имя хоста в ОС
    string hostname = 4;

    // Конфигурация VPS
    VpsConfiguration configuration = 5;

    // Текущий статус VPS
    VpsStatus status = 6;

    // Информация об ssh-ключах
    repeated structures.SshKeyInfo ssh_keys = 7;

    // Возможен ли вход по паролю
    bool has_password = 8;

    // Доступно ли управление данной Vps
    bool manage_enabled = 9;

    // Описание VPS
    string description = 10;

    // Дата создания (в формате W3C)
    string date_create = 11;

    // Операционная система
    structures.OperatingSystem operating_system = 12;

    // Основной IP-адрес
    string ip_address = 13;

    // Включен rescue-режим
    bool rescue_mode = 14;

    // VPS находится в состоянии миграции на другой хост
    bool migrating = 15;

    // Нет возможности получать информацию с хоста, на котором находится vps
    bool host_unavailable = 16;

    // VPS находится в состоянии разблокировки
    bool unblocking = 17;

    // VPS находится в состоянии восстановления из резервной копии
    bool restoring = 20;

    // Занято места на главном разделе, Мб
    uint64 disk_used = 21;

    // Осталось свободного места на главном разделе, Мб
    uint64 disk_left = 22;

    // Информация о дополнительных IP-адресах VPS
    repeated string additional_ip_address = 18;

    // Включение/выключение доступа ФМ к VPS
    bool beget_ssh_access_allowed = 19;

    // VPS заархивирована, управление невозможно
    bool archived = 23;

    // VPS в процессе разархивации
    bool unarchiving = 24;

    // Приватные сети к которым подключена VPS
    repeated structures.AttachedPrivateNetwork private_network = 25;

    // Технический домен, если он есть
    string technical_domain = 26;

    // Домен, указанный при установке софта
    string software_domain = 27;

    // Информация о установленном ПО
    structures.InstalledSoftwareInfo software = 28;
}

// Текущий статус Vps
enum VpsStatus {
    // Неизвестен
    UNKNOWN = 0;

    // Создается
    CREATING = 1;

    // Запущена
    RUNNING = 2;

    // Останавливается
    STOPPING = 3;

    // Перезагружается
    RESTARTING = 4;

    // Удаляется
    REMOVING = 5;

    // Удалена
    REMOVED = 6;

    // Остановлена
    STOPPED = 7;

    // Запускается
    STARTING = 8;

    // Переконфигурируется
    RECONFIGURING = 9;

    // Переустанавливается
    REINSTALLING = 10;
}

// Описывает параметры VPS
message VpsConfiguration {
    // Идентификатор конфигурации
    string id = 1;

    // Имя конфигурации VPS
    string name = 2;

    // Количество ядер процессора
    uint32 cpu_count = 3;

    // Объем дисковой квоты в Мб
    uint32 disk_size = 4;

    // Объем оперативной памяти в Мб
    uint32 memory = 5;

    // Цена в день
    double price_day = 6;

    // Цена в месяц
    double price_month = 7;

    // Доступен ли для заказа пользователем
    bool available = 8;

    // Является ли конфигурация персональной
    bool custom = 9;
}

message AttachIpAddressRequest {
    // Идентификатор VPS
    string id = 1;

    // IP-адрес
    string ip_address = 2;
}

message AttachIpAddressResponse {
    oneof result {
        // Информация о VPS
        VpsInfo vps = 1;

        // Ошибка при прикреплении дополнительного IP-адреса к VPS
        Error error = 2;
    }

    message Error {
        // Код ошибки
        Code code = 1;

        // Сообщение об ошибке
        string message = 2;

        enum Code {
            // Внутренняя ошибка сервера
            INTERNAL_ERROR = 0;

            // Произошла ошибка при добавлении дополнительного IP адреса внутри гостевой ОС
            GUEST_OS_ADD_IP_ADDRESS_FAILED = 1;
        }
    }
}

message DetachIpAddressRequest {
    // IP-адрес
    string ip_address = 1;
}

message DetachIpAddressResponse {
    oneof result {
        // Информация о VPS
        VpsInfo vps = 1;

        // Ошибка при откреплении дополнительного IP-адреса
        Error error = 2;
    }

    message Error {
        // Код ошибки
        Code code = 1;

        // Сообщение об ошибке
        string message = 2;

        enum Code {
            // Внутренняя ошибка сервера
            INTERNAL_ERROR = 0;

            // Произошла ошибка при удалении дополнительного IP адреса внутри гостевой ОС
            GUEST_OS_REMOVE_IP_ADDRESS_FAILED = 1;
        }
    }
}

message AttachToPrivateNetworkRequest {
    // Идентификатор VPS в формате uuid v4
    string id = 1;

    // Идентификатор сети
    string network_id = 2;

    // Желаемый ip-адрес. Если пустая строка, то выберется случайный
    string address = 3;
}

message AttachToPrivateNetworkResponse {
    oneof result {
        // Информация о VPS
        VpsInfo vps = 1;

        // Ошибка при добавлении к приватной сети
        Error error = 2;
    }

    message Error {
        // Код ошибки
        Code code = 1;

        // Сообщение об ошибке
        string message = 2;

        enum Code {
            // Внутренняя ошибка сервера
            INTERNAL_ERROR = 0;

            // Произошла ошибка при попытке внести изменения в конфигурацию адаптеров в гостевой ОС
            GUEST_OS_ERROR = 1;

            // В приватной сети не осталось свободных адресов
            NO_AVAILABLE_ADDRESSES = 2;

            // Передан некорректный адрес
            INVALID_ADDRESS = 3;

            // Переданный адрес не соответствует подсети
            ADDRESS_SUBNET_MISMATCH = 4;

            // Переданный адрес уже выделен
            ADDRESS_ALREADY_RESERVED = 5;

            // Переданный адрес недоступен
            ADDRESS_UNAVAILABLE = 6;
        }
    }
}

message DetachFromPrivateNetworkRequest {
    // Идентификатор VPS в формате uuid v4
    string id = 1;

    // Идентификатор сети
    string network_id = 2;
}

message DetachFromPrivateNetworkResponse {
    oneof result {
        // Информация о VPS
        VpsInfo vps = 1;

        // Ошибка при удалении VPS из приватной сети
        Error error = 2;
    }

    message Error {
        // Код ошибки
        Code code = 1;

        // Сообщение об ошибке
        string message = 2;

        enum Code {
            // Внутренняя ошибка сервера
            INTERNAL_ERROR = 0;

            // Произошла ошибка при попытке внести изменения в конфигурацию адаптеров в гостевой ОС
            GUEST_OS_ERROR = 1;
        }
    }
}

message ChangeSshAccessRequest {
    // Идентификатор VPS
    string id = 1;

    // Включение/выключение доступа ФМ к VPS
    bool beget_ssh_access_allowed = 2;
}

message ChangeSshAccessResponse {
    oneof result {
        // Информация о VPS
        VpsInfo vps = 1;

        // Ошибка при включении/выключении доступа ФМ к VPS
        Error error = 2;
    }

    message Error {
        // Код ошибки
        Code code = 1;

        // Сообщение об ошибке
        string message = 2;

        // Дополнительная информация
        string extra = 3;

        enum Code {
            // Внутренняя ошибка сервера
            INTERNAL_ERROR = 0;

            // Произошла ошибка при попытке внести изменения в authorized_keys в гостевой ОС
            GUEST_OS_ERROR = 1;
        }
    }
}

message GetFileManagerSettingsRequest {
    // Идентификатор VPS в формате uuid v4
    string id = 1;
}

message GetFileManagerSettingsResponse {
    oneof result {
        // Параметры для использования файлового менеджера
        Credentials credentials = 1;

        // Ошибка при получении параметров подключения к файловому менеджеру
        Error error = 2;
    }

    message Credentials {
        // Тип подключения(sftp/ssh/etc)
        string type = 1;

        // Логин
        string user = 2;

        // Хост
        string host = 3;

        // Идентификатор подключения
        uint32 connection_id = 4;

        // Корневой путь удаленной ФС
        string path = 5;
    }

    message Error {
        // Код ошибки
        Code code = 1;

        // Сообщение об ошибке
        string message = 2;

        enum Code {
            // Внутренняя ошибка
            INTERNAL_ERROR = 0;

            // Доступ к серверу по ssh для Beget запрещен
            SSH_ACCESS_NOT_ALLOWED = 1;
        }
    }
}

message SoftwareInstallInfo {
    // ID устанавливаемого ПО
    uint32 id = 1;

    // Дополнительные переменные для установки
    map<string,string> variable = 2;
}

message UnarchiveRequest {
    // Идентификатор VPS в формате uuid v4
    string id = 1;
}

message UnarchiveResponse {
    // Информация о VPS
    VpsInfo vps = 1;
}

message PrivateNetworkInfo {
    // ID сети
    string id = 1;
    // Желаемый ip-адрес. Если пустая строка, то выберется случайный
    string address = 2;
}


message ReserveVpsSubdomainRequest {
}

message ReserveVpsSubdomainResponse {
    oneof result {
        // Домен
        string vps_subdomain = 1;

        // Ошибка при резервировании домена
        Error error = 2;
    }

    message Error {
        // Код ошибки
        Code code = 1;

        // Сообщение об ошибке
        string message = 2;

        enum Code {
            // Внутренняя ошибка
            INTERNAL_ERROR = 0;

            // Поддомен уже зарезервирован
            SUBDOMAIN_RESERVED = 1;
        }
    }
}
